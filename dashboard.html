<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .dashboard-container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; margin: 20px auto; }
        h1 { color: #333; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .loading { text-align: center; color: #555; font-style: italic; }
        .back-link { margin-top: 20px; text-align: center; }
        .back-link a { color: #007bff; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>AI 공모전 제출 현황</h1>
        <p class="loading" id="loading-message">제출 목록을 불러오는 중입니다...</p>
        <table id="submissions-table" style="display: none;">
            <thead>
                <tr>
                    <th>참가자 이름</th>
                    <th>분반</th>
                    <th>제출 파일명</th>
                    <th>제출 시간</th>
                    <th>다운로드</th>
                </tr>
            </thead>
            <tbody id="submissions-body">
                </tbody>
        </table>
        <p id="no-submissions" style="display: none;">아직 제출된 파일이 없습니다.</p>
    </div>
    <div class="back-link">
        <a href="index.html">메인 페이지로 돌아가기</a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>

    <script>
        window.onload = function() {
            try {
                // 파이어베이스 설정: 당신의 실제 코드를 사용합니다.
                const firebaseConfig = {
                    apiKey: "AIzaSyAC-6B0FV9UI9hFB_UzEl4iXVQDjq9ukV0",
                    authDomain: "yangonebinaievent.firebaseapp.com",
                    projectId: "yangonebinaievent",
                    storageBucket: "yangonebinaievent.firebasestorage.app",
                    messagingSenderId: "136715708338",
                    appId: "1:136715708338:web:cdf2743235b2829010a6ab"
                };
                firebase.initializeApp(firebaseConfig);
                const db = firebase.firestore();
                const storage = firebase.storage();
                const storageRef = storage.ref();

                const submissionsTable = document.getElementById('submissions-table');
                const submissionsBody = document.getElementById('submissions-body');
                const loadingMessage = document.getElementById('loading-message');
                const noSubmissionsMessage = document.getElementById('no-submissions');

                // 제출 목록을 실시간으로 가져오기
                db.collection('submissions').orderBy('date', 'desc').onSnapshot(snapshot => {
                    submissionsBody.innerHTML = '';
                    if (snapshot.empty) {
                        loadingMessage.style.display = 'none';
                        submissionsTable.style.display = 'none';
                        noSubmissionsMessage.style.display = 'block';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const row = submissionsBody.insertRow();

                        // 날짜 포맷 변경 (YYYY-MM-DD HH:MM)
                        const date = new Date(data.date);
                        const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

                        row.insertCell(0).innerText = data.name;
                        row.insertCell(1).innerText = data.class_num + '반';
                        row.insertCell(2).innerText = data.filename;
                        row.insertCell(3).innerText = formattedDate;

                        const downloadCell = row.insertCell(4);
                        const downloadLink = document.createElement('a');
                        downloadLink.href = '#';
                        downloadLink.innerText = '다운로드';
                        downloadLink.addEventListener('click', async (e) => {
                            e.preventDefault();
                            try {
                                const fileRef = storageRef.child(data.filename);
                                const url = await fileRef.getDownloadURL();
                                window.open(url, '_blank');
                            } catch (error) {
                                console.error("파일 다운로드 중 오류 발생:", error);
                                alert('파일 다운로드에 실패했습니다.');
                            }
                        });
                        downloadCell.appendChild(downloadLink);
                    });
                    loadingMessage.style.display = 'none';
                    submissionsTable.style.display = 'table';
                });
            } catch (error) {
                console.error("파이어베이스 초기화 오류:", error);
                document.body.innerHTML = '파이어베이스 설정에 문제가 있습니다. 콘솔을 확인해주세요.';
            }
        };
    </script>
</body>
</html>